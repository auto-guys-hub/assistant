<script>
const form = document.getElementById('chat-form');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const chatContainer = document.getElementById('chat-container');

// âš™ï¸ update this to your active production webhook URL
const WEBHOOK_URL =
  "https://krishna-unfretful-antonomastically.ngrok-free.dev/webhook/a1";

// give every browser tab its own chatId
const CHAT_ID = localStorage.getItem("leoChatId") || Math.random().toString(36).slice(2);
localStorage.setItem("leoChatId", CHAT_ID);

// focus inside box on load
window.addEventListener('load', () => input.focus());

function createMessageElement(text, isUser) {
  const wrapper = document.createElement('div');
  wrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-anim`;
  const inner = `
    <div class="flex items-end gap-2 max-w-[85%] sm:max-w-[70%] ${isUser ? 'flex-row-reverse' : ''}">
      ${!isUser ? `
      <div class="w-8 h-8 rounded-full bg-green-600/20 flex-shrink-0 flex items-center justify-center border border-green-500/20">
        <span class="text-green-500 text-xs font-bold">L</span>
      </div>` : `
      <div class="w-8 h-8 rounded-full bg-gray-700 flex-shrink-0 flex items-center justify-center border border-gray-600">
        <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
      </div>`}
      <div class="${isUser 
        ? 'bg-green-600 text-white rounded-2xl rounded-br-none' 
        : 'bg-gray-800 text-gray-200 rounded-2xl rounded-bl-none border border-gray-700/50'} 
        py-3 px-5 shadow-sm leading-relaxed overflow-hidden break-words">
        <p>${escapeHtml(text)}</p>
      </div>
    </div>`;
  wrapper.innerHTML = inner;
  return wrapper;
}

function createTypingIndicator() {
  const wrapper = document.createElement('div');
  wrapper.id = 'typing-indicator';
  wrapper.className = 'flex justify-start message-anim';
  wrapper.innerHTML = `
    <div class="flex items-end gap-2 max-w-[85%]">
      <div class="w-8 h-8 rounded-full bg-green-600/20 flex-shrink-0 flex items-center justify-center border border-green-500/20">
        <span class="text-green-500 text-xs font-bold">L</span>
      </div>
      <div class="bg-gray-800 rounded-2xl rounded-bl-none py-4 px-5 border border-gray-700/50 flex items-center gap-1 h-[46px]">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    </div>`;
  return wrapper;
}

function scrollToBottom() {
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

function escapeHtml(text) {
  const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
  return text.replace(/[&<>"']/g, m => map[m]);
}

function clearChat() {
  const welcomeMsg = chatContainer.firstElementChild;
  chatContainer.innerHTML = '';
  if (welcomeMsg) chatContainer.appendChild(welcomeMsg);
}

async function handleSubmit(e) {
  e.preventDefault();
  const message = input.value.trim();
  if (!message) return;

  chatContainer.appendChild(createMessageElement(message, true));
  input.value = '';
  scrollToBottom();
  input.disabled = true;
  sendBtn.disabled = true;

  const typing = createTypingIndicator();
  chatContainer.appendChild(typing);
  scrollToBottom();

  try {
    const payload = {
      chatId: CHAT_ID,                     // ðŸ”‘ required for n8n Data Table
      message: message,
      timestamp: new Date().toISOString()
    };

    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    typing.remove();

    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const type = response.headers.get('content-type');
    let botText = "Received.";
    if (type && type.includes("application/json")) {
      const data = await response.json();
      botText = data.reply || data.output || data.message || data.text || JSON.stringify(data);
      if (typeof botText === "object") botText = JSON.stringify(botText, null, 2);
    } else {
      botText = await response.text();
    }
    chatContainer.appendChild(createMessageElement(botText, false));

  } catch (err) {
    console.error(err);
    if (document.getElementById('typing-indicator')) typing.remove();
    chatContainer.appendChild(
      createMessageElement("Iâ€™m having trouble connecting right now. Please try again.", false)
    );
  } finally {
    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
    scrollToBottom();
  }
}

form.addEventListener('submit', handleSubmit);
</script>
